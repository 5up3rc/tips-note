# coding:utf-8
import threading
import socket
import struct
import os
import sys
import time
import array
import logging

log = logging.getLogger('send_test')
console_handler = logging.StreamHandler(sys.stdout)
log.addHandler(console_handler)
log.setLevel(logging.INFO)

iplst_txt = '''
123.125.66.101
123.125.66.103
123.125.66.104
123.125.66.106
123.125.66.107
123.125.66.109
123.125.66.110
123.125.66.111
123.125.66.113
123.125.66.114
123.125.66.100
123.125.66.118
123.125.66.102
123.125.66.117
123.125.66.120
123.125.66.119
123.125.66.123
123.125.66.108
123.125.66.105
123.125.66.125
123.125.66.128
123.125.66.127
123.125.66.130
123.125.66.131
123.125.66.112
123.125.66.115
123.125.66.116
123.125.66.134
123.125.66.133
123.125.66.129
123.125.66.124
123.125.66.122
123.125.66.132
123.125.66.16
123.125.66.15
123.125.66.17
123.125.66.18
123.125.66.19
123.125.66.20
123.125.66.21
123.125.66.22
123.125.66.23
123.125.66.24
123.125.66.25
123.125.66.28
123.125.66.30
123.125.66.33
123.125.66.34
123.125.66.35
123.125.66.29
123.125.66.27
123.125.66.38
123.125.66.40
123.125.66.41
123.125.66.42
123.125.66.26
123.125.66.31
123.125.66.32
123.125.66.46
123.125.66.45
123.125.66.44
123.125.66.49
123.125.66.47
123.125.66.48
123.125.66.50
123.125.66.52
123.125.66.54
123.125.66.36
123.125.66.55
123.125.66.56
123.125.66.57
123.125.66.58
123.125.66.51
123.125.66.39
123.125.66.65
123.125.66.37
123.125.66.66
123.125.66.67
123.125.66.43
123.125.66.70
123.125.66.53
123.125.66.62
123.125.66.59
123.125.66.74
123.125.66.75
123.125.66.69
123.125.66.68
123.125.66.77
123.125.66.61
123.125.66.71
123.125.66.64
123.125.66.81
123.125.66.80
123.125.66.82
123.125.66.72
123.125.66.83
123.125.66.85
123.125.66.86
123.125.66.87
123.125.66.89
123.125.66.90
123.125.66.91
123.125.66.73
123.125.66.92
123.125.66.93
123.125.66.94
123.125.66.96
123.125.66.76
123.125.66.79
123.125.66.98
123.125.66.78
123.125.66.99
123.125.66.84
123.125.66.95
123.125.71.101
123.125.71.102
123.125.71.104
123.125.71.105
123.125.71.106
123.125.71.100
123.125.71.107
123.125.71.108
123.125.71.112
123.125.71.103
123.125.71.110
123.125.71.11
123.125.71.109
123.125.71.117
123.125.71.115
123.125.71.116
123.125.71.113
123.125.71.114
123.125.71.121
123.125.71.120
123.125.71.124
123.125.71.122
123.125.71.125
123.125.71.126
123.125.71.127
123.125.71.123
123.125.71.129
123.125.71.130
123.125.71.13
123.125.71.132
123.125.71.135
123.125.71.134
123.125.71.138
123.125.71.14
123.125.71.140
123.125.71.141
123.125.71.142
123.125.71.131
123.125.71.128
123.125.71.12
123.125.71.144
123.125.71.136
123.125.71.146
123.125.71.147
123.125.71.137
123.125.71.148
123.125.71.139
123.125.71.133
123.125.71.149
123.125.71.150
123.125.71.15
123.125.71.151
123.125.71.155
123.125.71.152
123.125.71.153
123.125.71.156
123.125.71.154
123.125.71.160
123.125.71.158
123.125.71.159
123.125.71.157
123.125.71.16
123.125.71.143
123.125.71.161
123.125.71.17
123.125.71.19
123.125.71.145
123.125.71.18
123.125.71.21
123.125.71.20
123.125.71.22
123.125.71.25
123.125.71.26
123.125.71.28
123.125.71.30
123.125.71.31
123.125.71.23
123.125.71.32
123.125.71.24
123.125.71.34
123.125.71.33
123.125.71.38
123.125.71.36
123.125.71.27
123.125.71.37
123.125.71.40
123.125.71.29
123.125.71.43
123.125.71.41
123.125.71.45
123.125.71.48
123.125.71.47
123.125.71.46
123.125.71.39
123.125.71.42
123.125.71.52
123.125.71.49
123.125.71.44
123.125.71.55
123.125.71.50
123.125.71.53
123.125.71.54
123.125.71.56
123.125.71.60
123.125.71.59
123.125.71.57
123.125.71.58
123.125.71.35
123.125.71.64
123.125.71.63
123.125.71.66
123.125.71.67
123.125.71.70
123.125.71.69
123.125.71.68
123.125.71.71
123.125.71.72
123.125.71.73
123.125.71.75
123.125.71.78
123.125.71.77
123.125.71.79
123.125.71.74
123.125.71.80
123.125.71.76
123.125.71.84
123.125.71.81
123.125.71.82
123.125.71.85
123.125.71.83
123.125.71.87
123.125.71.89
123.125.71.86
123.125.71.91
123.125.71.90
123.125.71.92
123.125.71.93
123.125.71.94
123.125.71.51
123.125.71.98
123.125.71.95
123.125.71.88
123.125.71.96
123.125.71.97
123.125.71.99
123.125.71.62
123.125.71.65
180.76.15.10
180.76.15.103
180.76.15.105
180.76.15.100
180.76.15.106
180.76.15.108
180.76.15.104
180.76.15.1
180.76.15.110
180.76.15.109
180.76.15.102
180.76.15.111
180.76.15.116
180.76.15.11
180.76.15.107
180.76.15.101
180.76.15.12
180.76.15.113
180.76.15.112
180.76.15.117
180.76.15.121
180.76.15.115
180.76.15.114
180.76.15.118
180.76.15.126
180.76.15.119
180.76.15.124
180.76.15.13
180.76.15.120
180.76.15.130
180.76.15.123
180.76.15.134
180.76.15.135
180.76.15.136
180.76.15.122
180.76.15.137
180.76.15.138
180.76.15.139
180.76.15.14
180.76.15.140
180.76.15.141
180.76.15.142
180.76.15.143
180.76.15.144
180.76.15.145
180.76.15.146
180.76.15.147
180.76.15.148
180.76.15.149
180.76.15.15
180.76.15.150
180.76.15.151
180.76.15.152
180.76.15.154
180.76.15.153
180.76.15.129
180.76.15.156
180.76.15.155
180.76.15.157
180.76.15.158
180.76.15.16
180.76.15.159
180.76.15.162
180.76.15.161
180.76.15.160
180.76.15.163
180.76.15.128
180.76.15.127
180.76.15.131
180.76.15.166
180.76.15.165
180.76.15.133
180.76.15.164
180.76.15.17
180.76.15.132
180.76.15.170
180.76.15.167
180.76.15.175
180.76.15.169
180.76.15.172
180.76.15.168
180.76.15.18
180.76.15.178
180.76.15.174
180.76.15.173
180.76.15.171
180.76.15.184
180.76.15.179
180.76.15.177
180.76.15.180
180.76.15.186
180.76.15.182
180.76.15.176
180.76.15.190
180.76.15.185
180.76.15.181
180.76.15.187
180.76.15.19
180.76.15.193
180.76.15.192
180.76.15.197
180.76.15.196
180.76.15.183
180.76.15.188
180.76.15.20
180.76.15.189
180.76.15.201
180.76.15.200
180.76.15.194
180.76.15.195
180.76.15.198
180.76.15.199
180.76.15.2
180.76.15.203
180.76.15.206
180.76.15.191
180.76.15.209
180.76.15.210
180.76.15.212
180.76.15.211
180.76.15.208
180.76.15.202
180.76.15.215
180.76.15.21
180.76.15.205
180.76.15.213
180.76.15.219
180.76.15.220
180.76.15.22
180.76.15.222
180.76.15.223
180.76.15.216
180.76.15.226
180.76.15.217
180.76.15.221
180.76.15.214
180.76.15.23
180.76.15.207
180.76.15.218
180.76.15.232
180.76.15.227
180.76.15.225
180.76.15.228
180.76.15.234
180.76.15.229
180.76.15.230
180.76.15.231
180.76.15.24
180.76.15.239
180.76.15.236
180.76.15.237
180.76.15.235
180.76.15.243
180.76.15.233
180.76.15.242
180.76.15.245
180.76.15.224
180.76.15.248
180.76.15.244
180.76.15.240
180.76.15.25
180.76.15.246
180.76.15.249
180.76.15.254
180.76.15.251
180.76.15.247
180.76.15.27
180.76.15.28
180.76.15.26
180.76.15.30
180.76.15.31
180.76.15.32
180.76.15.33
180.76.15.3
180.76.15.241
180.76.15.252
180.76.15.34
180.76.15.35
180.76.15.238
180.76.15.38
180.76.15.29
180.76.15.40
180.76.15.42
180.76.15.43
180.76.15.39
180.76.15.253
180.76.15.46
180.76.15.44
180.76.15.47
180.76.15.41
180.76.15.250
180.76.15.4
180.76.15.51
180.76.15.45
180.76.15.52
180.76.15.48
180.76.15.49
180.76.15.5
180.76.15.50
180.76.15.57
180.76.15.36
180.76.15.6
180.76.15.54
180.76.15.37
180.76.15.58
180.76.15.63
180.76.15.61
180.76.15.55
180.76.15.56
180.76.15.53
180.76.15.62
180.76.15.60
180.76.15.67
180.76.15.59
180.76.15.7
180.76.15.65
180.76.15.66
180.76.15.64
180.76.15.70
180.76.15.75
180.76.15.68
180.76.15.76
180.76.15.71
180.76.15.79
180.76.15.69
180.76.15.72
180.76.15.73
180.76.15.77
180.76.15.80
180.76.15.74
180.76.15.83
180.76.15.81
180.76.15.84
180.76.15.82
180.76.15.9
180.76.15.8
180.76.15.78
180.76.15.92
180.76.15.86
180.76.15.88
180.76.15.94
180.76.15.89
180.76.15.87
180.76.15.90
180.76.15.97
180.76.15.85
180.76.15.91
180.76.15.93
180.76.15.96
180.76.15.99
180.76.15.95
180.76.15.98
180.76.5.100
180.76.5.101
180.76.5.10
180.76.5.102
180.76.5.103
180.76.5.1
180.76.5.106
180.76.5.104
180.76.5.108
180.76.5.107
180.76.5.110
180.76.5.105
180.76.5.111
180.76.5.11
180.76.5.116
180.76.5.119
180.76.5.113
180.76.5.112
180.76.5.115
180.76.5.120
180.76.5.121
180.76.5.12
180.76.5.117
180.76.5.122
180.76.5.124
180.76.5.118
180.76.5.126
180.76.5.109
180.76.5.123
180.76.5.129
180.76.5.13
180.76.5.130
180.76.5.128
180.76.5.132
180.76.5.125
180.76.5.135
180.76.5.134
180.76.5.127
180.76.5.133
180.76.5.136
180.76.5.14
180.76.5.142
180.76.5.141
180.76.5.139
180.76.5.137
180.76.5.140
180.76.5.138
180.76.5.143
180.76.5.146
180.76.5.144
180.76.5.131
180.76.5.148
180.76.5.151
180.76.5.150
180.76.5.155
180.76.5.153
180.76.5.149
180.76.5.157
180.76.5.145
180.76.5.154
180.76.5.158
180.76.5.147
180.76.5.16
180.76.5.159
180.76.5.161
180.76.5.15
180.76.5.163
180.76.5.162
180.76.5.152
180.76.5.167
180.76.5.169
180.76.5.17
180.76.5.165
180.76.5.168
180.76.5.171
180.76.5.170
180.76.5.156
180.76.5.173
180.76.5.172
180.76.5.174
180.76.5.176
180.76.5.175
180.76.5.178
180.76.5.177
180.76.5.179
180.76.5.18
180.76.5.180
180.76.5.181
180.76.5.182
180.76.5.185
180.76.5.187
180.76.5.183
180.76.5.164
180.76.5.189
180.76.5.184
180.76.5.160
180.76.5.19
180.76.5.190
180.76.5.186
180.76.5.188
180.76.5.192
180.76.5.193
180.76.5.194
180.76.5.196
180.76.5.199
180.76.5.2
180.76.5.20
180.76.5.197
180.76.5.201
180.76.5.200
180.76.5.204
180.76.5.166
180.76.5.206
180.76.5.207
180.76.5.205
180.76.5.191
180.76.5.209
180.76.5.210
180.76.5.208
180.76.5.203
180.76.5.212
180.76.5.211
180.76.5.21
180.76.5.213
180.76.5.214
180.76.5.202
180.76.5.215
180.76.5.217
180.76.5.218
180.76.5.219
180.76.5.221
180.76.5.198
180.76.5.195
180.76.5.225
180.76.5.227
180.76.5.228
180.76.5.216
180.76.5.229
180.76.5.220
180.76.5.22
180.76.5.230
180.76.5.223
180.76.5.222
180.76.5.224
180.76.5.235
180.76.5.226
180.76.5.236
180.76.5.23
180.76.5.231
180.76.5.240
180.76.5.233
180.76.5.241
180.76.5.232
180.76.5.234
180.76.5.242
180.76.5.244
180.76.5.237
180.76.5.238
180.76.5.239
180.76.5.24
180.76.5.25
180.76.5.250
180.76.5.245
180.76.5.248
180.76.5.243
180.76.5.247
180.76.5.254
180.76.5.249
180.76.5.27
180.76.5.29
180.76.5.3
180.76.5.30
180.76.5.31
180.76.5.251
180.76.5.253
180.76.5.246
180.76.5.33
180.76.5.252
180.76.5.35
180.76.5.38
180.76.5.34
180.76.5.39
180.76.5.40
180.76.5.4
180.76.5.26
180.76.5.42
180.76.5.32
180.76.5.36
180.76.5.41
180.76.5.37
180.76.5.49
180.76.5.44
180.76.5.43
180.76.5.28
180.76.5.5
180.76.5.45
180.76.5.51
180.76.5.52
180.76.5.46
180.76.5.54
180.76.5.56
180.76.5.57
180.76.5.53
180.76.5.58
180.76.5.59
180.76.5.60
180.76.5.47
180.76.5.48
180.76.5.63
180.76.5.50
180.76.5.65
180.76.5.62
180.76.5.66
180.76.5.55
180.76.5.67
180.76.5.69
180.76.5.70
180.76.5.61
180.76.5.72
180.76.5.6
180.76.5.71
180.76.5.73
180.76.5.64
180.76.5.75
180.76.5.76
180.76.5.8
180.76.5.77
180.76.5.81
180.76.5.78
180.76.5.79
180.76.5.7
180.76.5.68
180.76.5.84
180.76.5.87
180.76.5.88
180.76.5.74
180.76.5.90
180.76.5.80
180.76.5.91
180.76.5.82
180.76.5.93
180.76.5.92
180.76.5.94
180.76.5.95
180.76.5.96
180.76.5.83
180.76.5.86
180.76.5.89
180.76.5.97
180.76.5.9
180.76.5.85
180.76.5.98
180.76.5.99
220.181.108.101
220.181.108.103
220.181.108.102
220.181.108.100
220.181.108.104
220.181.108.105
220.181.108.106
220.181.108.107
220.181.108.11
220.181.108.109
220.181.108.108
220.181.108.112
220.181.108.113
220.181.108.111
220.181.108.110
220.181.108.116
220.181.108.117
220.181.108.118
220.181.108.120
220.181.108.115
220.181.108.121
220.181.108.114
220.181.108.119
220.181.108.122
220.181.108.123
220.181.108.126
220.181.108.124
220.181.108.129
220.181.108.127
220.181.108.128
220.181.108.130
220.181.108.132
220.181.108.133
220.181.108.131
220.181.108.136
220.181.108.137
220.181.108.134
220.181.108.140
220.181.108.139
220.181.108.14
220.181.108.143
220.181.108.12
220.181.108.145
220.181.108.146
220.181.108.125
220.181.108.135
220.181.108.149
220.181.108.147
220.181.108.148
220.181.108.151
220.181.108.141
220.181.108.150
220.181.108.152
220.181.108.15
220.181.108.156
220.181.108.138
220.181.108.154
220.181.108.153
220.181.108.160
220.181.108.155
220.181.108.159
220.181.108.162
220.181.108.158
220.181.108.16
220.181.108.161
220.181.108.157
220.181.108.165
220.181.108.163
220.181.108.164
220.181.108.166
220.181.108.167
220.181.108.169
220.181.108.13
220.181.108.171
220.181.108.174
220.181.108.175
220.181.108.173
220.181.108.17
220.181.108.177
220.181.108.179
220.181.108.176
220.181.108.180
220.181.108.142
220.181.108.182
220.181.108.18
220.181.108.183
220.181.108.184
220.181.108.181
220.181.108.187
220.181.108.186
220.181.108.172
220.181.108.168
220.181.108.170
220.181.108.178
220.181.108.190
220.181.108.193
220.181.108.192
220.181.108.196
220.181.108.195
220.181.108.185
220.181.108.189
220.181.108.20
220.181.108.188
220.181.108.200
220.181.108.191
220.181.108.202
220.181.108.203
220.181.108.194
220.181.108.204
220.181.108.205
220.181.108.206
220.181.108.207
220.181.108.197
220.181.108.209
220.181.108.208
220.181.108.210
220.181.108.21
220.181.108.198
220.181.108.19
220.181.108.199
220.181.108.201
220.181.108.23
220.181.108.22
220.181.108.25
220.181.108.28
220.181.108.29
220.181.108.24
220.181.108.31
220.181.108.34
220.181.108.35
220.181.108.36
220.181.108.27
220.181.108.37
220.181.108.38
220.181.108.39
220.181.108.26
220.181.108.42
220.181.108.41
220.181.108.40
220.181.108.45
220.181.108.43
220.181.108.46
220.181.108.48
220.181.108.47
220.181.108.30
220.181.108.50
220.181.108.32
220.181.108.51
220.181.108.52
220.181.108.53
220.181.108.54
220.181.108.56
220.181.108.33
220.181.108.55
220.181.108.57
220.181.108.60
220.181.108.58
220.181.108.59
220.181.108.61
220.181.108.44
220.181.108.62
220.181.108.65
220.181.108.64
220.181.108.63
220.181.108.67
220.181.108.49
220.181.108.66
220.181.108.70
220.181.108.72
220.181.108.74
220.181.108.76
220.181.108.75
220.181.108.77
220.181.108.79
220.181.108.78
220.181.108.80
220.181.108.81
220.181.108.83
220.181.108.82
220.181.108.85
220.181.108.84
220.181.108.86
220.181.108.87
220.181.108.88
220.181.108.89
220.181.108.90
220.181.108.68
220.181.108.71
220.181.108.92
220.181.108.95
220.181.108.96
220.181.108.94
220.181.108.73
220.181.108.97
220.181.108.99
220.181.108.69
220.181.108.91
220.181.108.93
220.181.108.98
220.181.32.10
220.181.32.11
220.181.32.12
220.181.32.13
220.181.32.14
220.181.32.15
220.181.32.16
220.181.32.17
220.181.32.18
220.181.32.19
220.181.32.20
220.181.32.21
220.181.32.22
220.181.32.23
220.181.32.24
220.181.32.25
220.181.32.28
220.181.32.27
220.181.32.26
220.181.32.29
220.181.32.31
220.181.32.34
220.181.32.35
220.181.32.30
220.181.32.36
220.181.32.40
220.181.32.41
220.181.32.43
220.181.32.42
220.181.32.44
220.181.32.45
220.181.32.6
220.181.32.33
220.181.32.37
220.181.32.39
220.181.32.38
220.181.32.32
220.181.32.7
220.181.32.8
220.181.32.9
61.135.165.19
61.135.165.20
61.135.165.53
61.135.165.52
61.135.168.10
61.135.168.11
61.135.168.12
61.135.168.13
61.135.168.14
61.135.168.15
61.135.168.16
61.135.168.160
61.135.168.17
61.135.168.18
61.135.168.19
61.135.168.20
61.135.168.30
61.135.168.31
61.135.168.32
61.135.168.33
61.135.168.35
61.135.168.38
61.135.168.39
61.135.168.40
61.135.168.43
61.135.168.41
61.135.168.37
61.135.168.42
61.135.168.44
61.135.168.45
61.135.168.46
61.135.168.47
61.135.168.48
61.135.168.49
61.135.168.50
61.135.168.34
61.135.168.36
61.135.168.6
61.135.168.7
61.135.168.8
61.135.168.9
61.135.169.19
61.135.169.20
61.135.169.53
61.135.169.52
61.135.186.12
61.135.186.13
61.135.186.14
61.135.186.11
61.135.186.15
61.135.186.16
61.135.186.17
61.135.186.18
61.135.186.19
61.135.186.20
61.135.186.21
61.135.186.22
61.135.186.24
61.135.186.25
61.135.186.23
61.135.186.26
61.135.186.29
61.135.186.30
61.135.186.33
61.135.186.34
61.135.186.32
61.135.186.27
61.135.186.38
61.135.186.39
61.135.186.28
61.135.186.40
61.135.186.42
61.135.186.41
61.135.186.45
61.135.186.43
61.135.186.44
61.135.186.46
61.135.186.48
61.135.186.31
61.135.186.50
61.135.186.51
61.135.186.53
61.135.186.55
61.135.186.56
61.135.186.52
61.135.186.37
61.135.186.36
61.135.186.57
61.135.186.58
61.135.186.59
61.135.186.35
61.135.186.47
61.135.186.54
61.135.186.49
61.135.186.60
'''

class SendPingThr(threading.Thread):
    def __init__(self, ipPool, icmpPacket, icmpSocket, timeout=3):
        threading.Thread.__init__(self)
        self.Sock = icmpSocket
        self.ipPool = ipPool
        self.packet = icmpPacket
        self.timeout = timeout
        self.Sock.settimeout(timeout + 1)

    def run(self):
        for ip in self.ipPool:
            try:
                self.Sock.sendto(self.packet, (ip, 0))
                log.debug('[-] send to %s', ip)
            except socket.timeout:
                break
            except Exception as ex:
                log.error('[!] send error : %s.', ex)
                pass
        time.sleep(self.timeout)


class Nscan:
    def __init__(self, timeout=3):
        self.timeout = timeout
        self.__data = struct.pack('d', time.time())
        self.__id = os.getpid()
        if self.__id >= 65535: self.__id = 65534

    @property
    def __icmpSocket(self):
        Sock = socket.socket(socket.AF_INET, socket.SOCK_RAW, socket.getprotobyname("icmp"))
        return Sock

    def __inCksum(self, packet):
        if len(packet) & 1:
            packet = packet + '\0'
        words = array.array('h', packet)
        sum = 0
        for word in words:
            sum += (word & 0xffff)
        sum = (sum >> 16) + (sum & 0xffff)
        sum = sum + (sum >> 16)
        return (~sum) & 0xffff

    @property
    def __icmpPacket(self):
        header = struct.pack('bbHHh', 8, 0, 0, self.__id, 0)
        packet = header + self.__data
        chkSum = self.__inCksum(packet)
        header = struct.pack('bbHHh', 8, 0, chkSum, self.__id, 0)
        return header + self.__data

    def mPing(self, ipPool):
        Sock = self.__icmpSocket
        Sock.settimeout(self.timeout)
        packet = self.__icmpPacket
        recvFroms = []
        sendThr = SendPingThr(ipPool, packet, Sock, self.timeout)
        sendThr.start()
        while True:
            try:
                ac_ip = Sock.recvfrom(1024)[1][0]
                if ac_ip not in recvFroms:
                    log.debug("[*] active: %s", ac_ip)
                    recvFroms.append(ac_ip)
            except Exception as ex:
                log.error('[!] recv error : %s.', ex)
                pass
            finally:
                if not sendThr.isAlive():
                    break
        return recvFroms


if __name__ == '__main__':
    scan = Nscan()
    ip_lst = iplst_txt.split()
    log.info('[*] len: %s', len(ip_lst))
    res = scan.mPing(ip_lst)
    log.info('[*] result len: %s', len(res))
    print(res)
